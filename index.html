<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ruusterit</title>
    <style>
      :root {
        --bg: #000;
        --fg: #f2f2f2;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
      }

      body {
        display: grid;
        place-items: center;
        background: var(--bg);
        color: var(--fg);
        font-family: "Times New Roman", Times, serif;
        letter-spacing: 0.02em;
      }

      .mark {
        font-size: clamp(6rem, 20vw, 14rem);
        line-height: 1;
        user-select: none;
      }

      button.mark {
        appearance: none;
        border: none;
        background: transparent;
        color: inherit;
        cursor: pointer;
        padding: 0;
      }

      button.mark:focus-visible {
        outline: 2px solid #666;
        outline-offset: 6px;
      }

    </style>
  </head>
  <body>
    <button class="mark" type="button" aria-label="Start audio">?</button>
    <script>
      const MORSE = {
        A: ".-",
        B: "-...",
        C: "-.-.",
        D: "-..",
        E: ".",
        F: "..-.",
        G: "--.",
        H: "....",
        I: "..",
        J: ".---",
        K: "-.-",
        L: ".-..",
        M: "--",
        N: "-.",
        O: "---",
        P: ".--.",
        Q: "--.-",
        R: ".-.",
        S: "...",
        T: "-",
        U: "..-",
        V: "...-",
        W: ".--",
        X: "-..-",
        Y: "-.--",
        Z: "--..",
      };

      const message = "Ruusterit";
      const unit = 0.12;
      const freq = 700;

      let context;
      let activeNodes = [];

      const startButton = document.querySelector(".mark");

      function encodeMorse(text) {
        return text
          .toUpperCase()
          .split("")
          .map((char) => MORSE[char] || "")
          .filter(Boolean);
      }

      function scheduleTone(context, startTime, duration) {
        const oscillator = context.createOscillator();
        const gain = context.createGain();
        oscillator.type = "sine";
        oscillator.frequency.value = freq;
        gain.gain.value = 0.0;

        oscillator.connect(gain);
        gain.connect(context.destination);

        oscillator.start(startTime);
        gain.gain.setValueAtTime(0.0, startTime);
        gain.gain.linearRampToValueAtTime(0.2, startTime + 0.01);
        gain.gain.setValueAtTime(0.2, startTime + duration - 0.01);
        gain.gain.linearRampToValueAtTime(0.0, startTime + duration);
        oscillator.stop(startTime + duration + 0.02);
        activeNodes.push(oscillator);
      }

      function playMorse(context, letters) {
        let t = context.currentTime + 0.2;

        letters.forEach((pattern, index) => {
          pattern.split("").forEach((symbol, symbolIndex) => {
            const toneDuration = symbol === "." ? unit : unit * 3;
            scheduleTone(context, t, toneDuration);
            t += toneDuration;
            if (symbolIndex < pattern.length - 1) {
              t += unit;
            }
          });

          if (index < letters.length - 1) {
            t += unit * 3;
          }
        });
      }

      function stopActive() {
        activeNodes.forEach((node) => {
          try {
            node.stop();
          } catch (error) {
            // Ignore nodes that already stopped.
          }
        });
        activeNodes = [];
      }

      async function startAudio() {
        if (!context) {
          context = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (context.state === "suspended") {
          await context.resume();
        }
        if (context.state !== "running") {
          return;
        }
        stopActive();
        const letters = encodeMorse(message);
        playMorse(context, letters);
      }

      startButton.addEventListener("click", startAudio);
      startButton.addEventListener("pointerdown", startAudio);
      startButton.addEventListener("touchstart", startAudio, { passive: true });
    </script>
  </body>
</html>
